<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Income & Expenses | Expense Manager</title>

  <!-- CSS & Icons -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body class="dashboard-page">
  <!-- HEADER -->
  <header class="main-header">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo-img">
    <h3>Expense Manager â€” Add & Organize</h3>
  </header>

  <!-- MAIN CONTENT -->
  <main class="dashboard-content">
    <div class="welcome-box">
      <h2>Manage Your Finances</h2>
      <p>Add your income, expenses, and organize them into categories.</p>
    </div>

    <!-- FIXED INCOME SECTION -->
    <div class="section-box">
      <div class="section-header">
        <h4>ðŸ’° Income Sources</h4>
      </div>

      <div class="add-entry-form">
        <input type="text" id="incomeTitle" class="form-control" placeholder="e.g. Salary, Rent, Freelance" />
        <input type="number" id="incomeAmount" class="form-control" placeholder="Amount" min="0" step="0.01" />
        <button class="btn-primary" id="addIncomeBtn">Add Income</button>
      </div>

      <div id="incomeList" class="entries-list">
        <p class="no-entry-text">No income added yet.</p>
      </div>
    </div>

    <!-- ADD SECTION FORM -->
    <div class="auth-container" id="add-section">
      <h3 class="form-title">Create a New Expense Section</h3>
      <form id="sectionForm">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-folder-plus"></i></span>
          <input type="text" id="sectionName" class="form-control" placeholder="e.g. SIPs, Home Expenses, Entertainment" required>
        </div>
        <button type="submit" class="btn-primary">Add Section</button>
      </form>
    </div>

    <!-- DYNAMIC SECTIONS -->
    <div id="sectionsContainer"></div>

    <!-- ACTION BUTTONS -->
    <div class="text-center mt-5">
      <a href="/summary" class="btn-card-outline" style="padding:0.8rem 2rem;">
        <i class="bi bi-bar-chart-line"></i> View Summary
      </a>
    </div>
  </main>

  <!-- JAVASCRIPT -->
  <script>
    const sectionForm = document.getElementById('sectionForm');
    const sectionNameInput = document.getElementById('sectionName');
    const sectionsContainer = document.getElementById('sectionsContainer');
    const addIncomeBtn = document.getElementById('addIncomeBtn');
    const incomeList = document.getElementById('incomeList');
    let sections = [];
    let incomeEntries = [];

    // ðŸ”¹ Load all sections + incomes from backend
    async function loadSections() {
      const res = await fetch("/get-sections");
      const data = await res.json();
      if (data.status === "success") {
        sections = data.sections;
        renderSections();
      }

      // Load existing income entries
      const incomeRes = await fetch("/get-incomes");
      const incomeData = await incomeRes.json();
      if (incomeData.status === "success") {
        incomeEntries = incomeData.entries;
        renderIncomes();
      }
    }

    // ðŸ”¹ Add Income
    addIncomeBtn.addEventListener('click', async () => {
      const title = document.getElementById('incomeTitle').value.trim();
      const amount = parseFloat(document.getElementById('incomeAmount').value);
      if (!title || isNaN(amount) || amount <= 0) return alert("Enter valid income details!");

      const res = await fetch("/save-entry", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ section_id: "income_section", title, amount, type: "income" })
      });

      const data = await res.json();
      if (data.status === "success") {
        incomeEntries.push(data.entry);
        renderIncomes();
        document.getElementById('incomeTitle').value = '';
        document.getElementById('incomeAmount').value = '';
      }
    });

    // ðŸ”¹ Render Income List
    function renderIncomes() {
      if (incomeEntries.length === 0) {
        incomeList.innerHTML = "<p class='no-entry-text'>No income added yet.</p>";
        return;
      }
      incomeList.innerHTML = incomeEntries.map(entry => `
        <div class="entry-item">
          <span>${entry.title}</span>
          <span>â‚¹${entry.amount.toFixed(2)}</span>
        </div>
      `).join('');
    }

    // ðŸ”¹ Add new custom section
    sectionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = sectionNameInput.value.trim();
      if (!name) return;
      const res = await fetch("/save-section", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });
      const data = await res.json();
      if (data.status === "success") {
        sections.push(data.section);
        renderSections();
        sectionNameInput.value = '';
      } else {
        alert(data.message);
      }
    });

    // ðŸ”¹ Add entry to a section
    async function handleAddEntry(sectionId) {
      const titleInput = document.getElementById(`entryTitle-${sectionId}`);
      const amountInput = document.getElementById(`entryAmount-${sectionId}`);
      const typeSelect = document.getElementById(`entryType-${sectionId}`);

      const title = titleInput.value.trim();
      const amount = parseFloat(amountInput.value);
      const type = typeSelect.value;

      if (!title || isNaN(amount) || amount <= 0) return;

      const res = await fetch("/save-entry", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ section_id: sectionId, title, amount, type })
      });

      const data = await res.json();
      if (data.status === "success") {
        const section = sections.find(s => s._id === sectionId);
        section.entries.push(data.entry);
        renderSections();
        titleInput.value = '';
        amountInput.value = '';
      }
    }

    // ðŸ”¹ Render all custom sections
    function renderSections() {
      sectionsContainer.innerHTML = '';
      sections.forEach(section => {
        const div = document.createElement('div');
        div.classList.add('section-box');
        div.innerHTML = `
          <div class="section-header">
            <h4>${section.name}</h4>
          </div>
          <div class="add-entry-form">
            <input type="text" id="entryTitle-${section._id}" class="form-control" placeholder="Entry title">
            <input type="number" id="entryAmount-${section._id}" class="form-control" placeholder="Amount" min="0" step="0.01">
            <select id="entryType-${section._id}" class="form-control">
              <option value="expense" selected>Expense</option>
              <option value="income">Income</option>
            </select>
            <button class="btn-primary" type="button" onclick="handleAddEntry('${section._id}')">Add</button>
          </div>
          <div class="entries-list">
            ${section.entries && section.entries.length > 0
              ? section.entries.map(entry => `
                <div class="entry-item">
                  <span>${entry.title}</span>
                  <span>${entry.type === 'income' ? '+' : '-'}â‚¹${entry.amount.toFixed(2)}</span>
                </div>`).join('')
              : `<p class="no-entry-text">No entries yet.</p>`}
          </div>
        `;
        sectionsContainer.appendChild(div);
      });
    }

    loadSections(); // Load existing data
  </script>
</body>
</html>
