<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Sections & Entries | Expense Manager</title>

  <!-- CSS & Icons -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body class="dashboard-page">
  <!-- HEADER -->
  <header class="main-header">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo-img">
    <h3>Expense Manager — Add & Organize</h3>
  </header>

  <!-- MAIN CONTENT -->
  <main class="dashboard-content">
    <div class="welcome-box">
      <h2>Manage Your Finances</h2>
      <p>Add sections (like Salary, SIPs, or Home Expenses) and track entries under them.</p>
    </div>

    <!-- ADD SECTION FORM -->
    <div class="auth-container" id="add-section">
      <h3 class="form-title">Create a New Section</h3>
      <form id="sectionForm">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-folder-plus"></i></span>
          <input type="text" id="sectionName" class="form-control" placeholder="e.g. Salary, SIPs, Home Expenses" required>
        </div>
        <button type="submit" class="btn-primary">Add Section</button>
      </form>
    </div>

    <!-- DYNAMIC SECTIONS -->
    <div id="sectionsContainer"></div>

    <!-- ACTION BUTTONS -->
    <div class="text-center mt-5">
      <button id="saveAllBtn" class="btn-primary" style="width:200px; margin-right:10px;">
        <i class="bi bi-save"></i> Save All
      </button>
      <a href="/summary" class="btn-card-outline" style="padding:0.8rem 2rem;">
        <i class="bi bi-bar-chart-line"></i> View Summary
      </a>
    </div>
  </main>

  <!-- JAVASCRIPT -->
  <script>
    const sectionForm = document.getElementById('sectionForm');
    const sectionNameInput = document.getElementById('sectionName');
    const sectionsContainer = document.getElementById('sectionsContainer');
    const saveAllBtn = document.getElementById('saveAllBtn');
    let sections = [];

    // Load existing sections from backend
    async function loadSections() {
      const res = await fetch("/get-sections");
      const data = await res.json();
      if (data.status === "success") {
        sections = data.sections;
        renderSections();
      }
    }

    // Add new section
    sectionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = sectionNameInput.value.trim();
      if (!name) return;
      const res = await fetch("/save-section", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });
      const data = await res.json();
      if (data.status === "success") {
        sections.push(data.section);
        renderSections();
        sectionNameInput.value = '';
      } else {
        alert(data.message);
      }
    });

    // Add entry to section (and save immediately)
    async function handleAddEntry(sectionId) {
      const titleInput = document.getElementById(`entryTitle-${sectionId}`);
      const amountInput = document.getElementById(`entryAmount-${sectionId}`);
      const title = titleInput.value.trim();
      const amount = parseFloat(amountInput.value);
      if (!title || isNaN(amount) || amount <= 0) return;

      const res = await fetch("/save-entry", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          section_id: sectionId,
          title,
          amount,
          type: "expense"
        })
      });

      const data = await res.json();
      if (data.status === "success") {
        const section = sections.find(s => s._id === sectionId);
        section.entries.push(data.entry);
        renderSections();
        titleInput.value = '';
        amountInput.value = '';
      } else {
        alert("Error saving entry: " + data.message);
      }
    }

    // Save all to backend (not really needed since we save each entry instantly)
    saveAllBtn.addEventListener('click', async () => {
      alert("✅ All your expenses are already saved in the database!");
    });

    // Delete section (frontend only for now)
    async function deleteSection(sectionId) {
      if (!confirm("Delete this section?")) return;
      sections = sections.filter(s => s._id !== sectionId);
      renderSections();
    }

    // Render all sections
    function renderSections() {
      sectionsContainer.innerHTML = '';
      sections.forEach(section => {
        const div = document.createElement('div');
        div.classList.add('section-box');
        div.innerHTML = `
          <div class="section-header">
            <h4>${section.name}</h4>
            <button class="delete-btn" onclick="deleteSection('${section._id}')">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          <div class="add-entry-form">
            <input type="text" id="entryTitle-${section._id}" class="form-control" placeholder="Entry title (e.g. Groceries, Rent, SIP name)">
            <input type="number" id="entryAmount-${section._id}" class="form-control" placeholder="Amount" min="0" step="0.01">
            <button class="btn-primary" type="button" onclick="handleAddEntry('${section._id}')">Add Entry</button>
          </div>
          <div class="entries-list">
            ${section.entries && section.entries.length > 0
              ? section.entries.map(entry => `
                <div class="entry-item">
                  <span>${entry.title}</span>
                  <span>₹${entry.amount.toFixed(2)}</span>
                </div>
              `).join('')
              : `<p class="no-entry-text">No entries yet.</p>`}
          </div>
        `;
        sectionsContainer.appendChild(div);
      });
    }

    loadSections(); // Load user’s existing data
  </script>
</body>
</html>
