<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Income & Expenses | Expense Manager</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="dashboard-page">
  <header class="main-header">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo-img">
    <h3>Expense Manager â€” Add & Organize</h3>
  </header>
  <main class="dashboard-content">
    <div class="welcome-box">
      <h2>Manage Your Finances</h2>
      <p>Add your income, expenses, and organize them by month using a calendar picker.</p>
    </div>
    <div class="section-box">
      <div class="section-header">
        <h4>ðŸ’° Income Sources</h4>
      </div>
      <div class="add-entry-form horizontal-form">
        <input type="text" id="incomeTitle" class="form-control" placeholder="Title (e.g. Salary, Rent)">
        <input type="number" id="incomeAmount" class="form-control" placeholder="Amount" min="0" step="0.01">
        <input type="month" id="incomeDate" class="form-control">
        <button class="btn-primary" id="addIncomeBtn">Add</button>
      </div>
      <div id="incomeList" class="entries-list">
        <p class="no-entry-text">No income added yet.</p>
      </div>
    </div>
    <div class="auth-container" id="add-section">
      <h3 class="form-title">Create a New Expense Section</h3>
      <form id="sectionForm">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-folder-plus"></i></span>
          <input type="text" id="sectionName" class="form-control" placeholder="e.g. SIPs, Home Expenses" required>
        </div>
        <button type="submit" class="btn-primary">Add Section</button>
      </form>
    </div>
    <div id="sectionsContainer"></div>
    <div class="text-center mt-5">
      <a href="/summary" class="btn-card-outline view-summary-btn">
        <i class="bi bi-bar-chart-line"></i> View Summary
      </a>
    </div>
  </main>
  <script>
    const sectionForm = document.getElementById('sectionForm');
    const sectionNameInput = document.getElementById('sectionName');
    const sectionsContainer = document.getElementById('sectionsContainer');
    const addIncomeBtn = document.getElementById('addIncomeBtn');
    const incomeList = document.getElementById('incomeList');
    let sections = [];
    let incomeEntries = [];
    async function loadSections() {
      const res = await fetch("/get-sections");
      const data = await res.json();
      if (data.status === "success") sections = data.sections;
      const incomeRes = await fetch("/get-incomes");
      const incomeData = await incomeRes.json();
      if (incomeData.status === "success") incomeEntries = incomeData.entries;
      renderSections();
      renderIncomes();
      const today = new Date();
      document.getElementById('incomeDate').value = today.toISOString().slice(0, 7);
    }
    addIncomeBtn.addEventListener('click', async () => {
      const title = document.getElementById('incomeTitle').value.trim();
      const amount = parseFloat(document.getElementById('incomeAmount').value);
      const dateValue = document.getElementById('incomeDate').value;
      if (!title || isNaN(amount) || amount <= 0 || !dateValue) return alert("Enter valid income details!");
      const [year, monthNum] = dateValue.split("-");
      const month = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long' });
      const res = await fetch("/save-entry", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ section_id: "income_section", title, amount, type: "income", month, year })
      });
      const data = await res.json();
      if (data.status === "success") {
        incomeEntries.push(data.entry);
        renderIncomes();
        document.getElementById('incomeTitle').value = '';
        document.getElementById('incomeAmount').value = '';
      }
    });
    function renderIncomes() {
      if (incomeEntries.length === 0) {
        incomeList.innerHTML = "<p class='no-entry-text'>No income added yet.</p>";
        return;
      }
      incomeList.innerHTML = incomeEntries.map(e => `
        <div class="entry-item">
          <span>${e.title}</span>
          <span>â‚¹${e.amount.toFixed(2)} (${e.month || ''} ${e.year || ''})</span>
          <button class="delete-btn" onclick="deleteEntry('${e._id}')">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      `).join('');
    }
    sectionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = sectionNameInput.value.trim();
      if (!name) return;
      const res = await fetch("/save-section", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name })
      });
      const data = await res.json();
      if (data.status === "success") {
        sections.push(data.section);
        renderSections();
        sectionNameInput.value = '';
      }
    });
    function toggleType(id) {
      const toggle = document.getElementById(`toggle-${id}`);
      const label = document.getElementById(`toggle-label-${id}`);
      toggle.classList.toggle("active");
      label.textContent = toggle.classList.contains("active") ? "Income" : "Expense";
    }
    async function handleAddEntry(sectionId) {
      const titleInput = document.getElementById(`entryTitle-${sectionId}`);
      const amountInput = document.getElementById(`entryAmount-${sectionId}`);
      const dateInput = document.getElementById(`entryDate-${sectionId}`);
      const toggle = document.getElementById(`toggle-${sectionId}`);
      const title = titleInput.value.trim();
      const amount = parseFloat(amountInput.value);
      const dateValue = dateInput.value;
      if (!title || isNaN(amount) || amount <= 0 || !dateValue) return;
      const [year, monthNum] = dateValue.split("-");
      const month = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long' });
      const type = toggle.classList.contains("active") ? "income" : "expense";
      const res = await fetch("/save-entry", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ section_id: sectionId, title, amount, type, month, year })
      });
      const data = await res.json();
      if (data.status === "success") {
        const section = sections.find(s => s._id === sectionId);
        section.entries.push(data.entry);
        renderSections();
        titleInput.value = '';
        amountInput.value = '';
      }
    }
    async function deleteSection(id) {
      if (!confirm("Delete this section?")) return;
      await fetch(`/delete-section/${id}`, { method: "DELETE" });
      sections = sections.filter(s => s._id !== id);
      renderSections();
    }
    async function deleteEntry(id) {
      if (!confirm("Delete this entry?")) return;
      await fetch(`/delete-entry/${id}`, { method: "DELETE" });
      incomeEntries = incomeEntries.filter(e => e._id !== id);
      sections.forEach(s => s.entries = s.entries.filter(e => e._id !== id));
      renderSections();
      renderIncomes();
    }
    function renderSections() {
      sectionsContainer.innerHTML = '';
      sections.forEach(section => {
        const div = document.createElement('div');
        div.classList.add('section-box');
        div.innerHTML = `
          <div class="section-header">
            <h4>${section.name}</h4>
            <button class="delete-btn" onclick="deleteSection('${section._id}')">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          <div class="add-entry-form horizontal-form">
            <input type="text" id="entryTitle-${section._id}" class="form-control" placeholder="Title">
            <input type="number" id="entryAmount-${section._id}" class="form-control" placeholder="Amount" min="0" step="0.01">
            <input type="month" id="entryDate-${section._id}" class="form-control">
            <div class="toggle-container">
              <div class="toggle-switch" id="toggle-${section._id}" onclick="toggleType('${section._id}')"></div>
              <span class="toggle-label" id="toggle-label-${section._id}">Expense</span>
            </div>
            <button class="btn-primary" type="button" onclick="handleAddEntry('${section._id}')">Add</button>
          </div>
          <div class="entries-list">
            ${section.entries && section.entries.length > 0
              ? section.entries.map(e => `
                <div class="entry-item">
                  <span>${e.title}</span>
                  <span>${e.type === 'income' ? '+' : '-'}â‚¹${e.amount.toFixed(2)} (${e.month || ''} ${e.year || ''})</span>
                  <button class="delete-btn" onclick="deleteEntry('${e._id}')">
                    <i class="bi bi-x-circle"></i>
                  </button>
                </div>`).join('')
              : `<p class="no-entry-text">No entries yet.</p>`}
          </div>
        `;
        sectionsContainer.appendChild(div);
        document.getElementById(`entryDate-${section._id}`).value = new Date().toISOString().slice(0, 7);
      });
    }
    loadSections();
  </script>
</body>
</html>
